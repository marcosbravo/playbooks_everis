---

- name:
  hosts: all
  gather_facts: false
  tasks:

    # WINDOWS BLOCK

    - name: NewRelic | Install Infraestructure Windows Agent | 1. Check New Relic Service is alredy present
      win_service:
        name: newrelic-infra
      register: service_existence

    - name: NewRelic | Install Infraestructure Windows Agent | Information
      debug:
        msg:
          - "Actually newrelic agent version is alredy Installed"
          - "If is not the latest version of agent, then Uninstall and Re-Install the latest agent of newrelic version"
      when: service_existence.state is defined

    - name: NewRelic | Install Infraestructure Windows Agent | 1. Set License New Relic environment variable
      win_environment:
        state: present
        name: LICENSE_NEW_RELIC_KEY
        value: '{{ newrelic_license_key }}'
        level: machine
      when: service_existence.state is not defined

    # - name: NewRelic | Install Infraestructure Windows Agent | 2.0 Check if is presente MSI New Relic Agent
    #   win_stat:
    #     path: 'C:\Windows\temp\newrelic-infra.msi'
    #   register: stat_file

    - name:  NewRelic | Install Infraestructure Windows Agent | 2. Get MSI New Relic Agent
      win_get_url:
        url: https://download.newrelic.com/infrastructure_agent/windows/newrelic-infra.msi
        dest: C:\Windows\temp\newrelic-infra.msi
      register: newrelic_get_status
      when: service_existence.state is not defined

    - name: NewRelic | Install Infraestructure Windows Agent | 3. Install Agent MSI
      win_package:
        path: C:\Windows\temp\newrelic-infra.msi
        state: present
        arguments: GENERATE_CONFIG=true LICENSE_NEW_RELIC_KEY='{{ newrelic_license_key }}'
      register: nr_agent_installed
      when: service_existence.state is not defined

    - name: NewRelic | Install Infraestructure Windows Agent | 4. Start Agent MSI
      win_shell: net start newrelic-infra
      when: service_existence.state is not defined
